sudo: required
dist: trusty
language: ruby
rvm:
  - 2.6.3
services:
  - docker
before_install:
  - gem update --system
  - gem install bundler
  - openssl aes-256-cbc -K $encrypted_21c873d1cdfb_key -iv $encrypted_21c873d1cdfb_iv
    -in deploy_key.enc -out ./deploy_key -d
script:
  - docker-compose -f docker-compose-production.yml run --rm backend bundle install
  - docker-compose -f docker-compose-production.yml postgres up
  - docker-compose -f docker-compose-production.yml run --rm backend bundle exec rails db:create db:migrate 
deploy:
  provider: script
  script: chmod 600 deploy_key && ssh -o StrictHostKeyChecking=no - i deploy_key $DEPLOY_USER@DEPLOY_HOST deploy.sh
  on:
    branch: master
